library(lightgbm)
library(data.table)

set.seed(3)

#--------------------------- 13:50
cat("Loading data...\n")

dt <- fread("../input/train.csv", drop = "MachineIdentifier")
# dt <- dt[sample(.N, .N %/% 2), ]

y <- dt[, HasDetections]
dt[, HasDetections := NULL]
N <- dt[, .N]

dt <- rbind(dt, fread("../input/test.csv", drop = "MachineIdentifier"))

#---------------------------
cat("Adding features...\n")

dt[,'fe_non_prim_drive'] <- dt[,'Census_PrimaryDiskTotalCapacity'] - dt[,'Census_SystemVolumeTotalCapacity']
dt[,'fe_aspect_ratio'] = dt[,'Census_InternalPrimaryDisplayResolutionHorizontal'] / dt[,'Census_InternalPrimaryDisplayResolutionVertical']
dt[,'fe_screen_area'] = (dt[, 'fe_aspect_ratio'] * (dt[, 'Census_InternalPrimaryDiagonalDisplaySizeInInches']**2)) / (dt[, 'fe_aspect_ratio']**2 + 1)
dt[,'fe_monitor_dims'] = dt[,'Census_InternalPrimaryDisplayResolutionHorizontal'] * dt[,'Census_InternalPrimaryDisplayResolutionVertical']


dt[, f1 := .N / nrow(dt), by = "AvSigVersion,Wdft_IsGamer"
  ][, f2 := .N / nrow(dt), by = "Census_ProcessorCoreCount,Wdft_RegionIdentifier"
  ][, f3 := .N / nrow(dt), by = "Census_ProcessorCoreCount,Census_OEMNameIdentifier"
  ][, f4 := .N / nrow(dt), by = "GeoNameIdentifier,Census_OEMNameIdentifier"
  ][, f5 := .N / nrow(dt), by = "AVProductStatesIdentifier,OsVer"
  ][, f6 := .N / nrow(dt), by = "AVProductStatesIdentifier,Platform"
  ][, f7 := .N / nrow(dt), by = "AVProductsInstalled,AVProductsEnabled"
  ][, f8 := .N / nrow(dt), by = "AVProductsInstalled,AutoSampleOptIn"
  ][, f9 := .N / nrow(dt), by = "IsBeta,AVProductsInstalled"
  ][, f10 := .N / nrow(dt), by = "AVProductsInstalled,Census_DeviceFamily"
  ][, f11 := .N / nrow(dt), by = "SmartScreen,Census_ActivationChannel"
  ][, f12 := .N / nrow(dt), by = "AVProductStatesIdentifier,SMode"
  ][, f13 := .N / nrow(dt), by = "AVProductsInstalled,Census_IsFlightsDisabled"
  ][, f14 := .N / nrow(dt), by = "AVProductStatesIdentifier,OsSuite"
  ][, f15 := .N / nrow(dt), by = "AVProductsInstalled,Census_IsFlightingInternal"
  ][, f16 := .N / nrow(dt), by = "RtpStateBitfield,SmartScreen"
  ][, f17 := .N / nrow(dt), by = "AVProductStatesIdentifier,Firewall"
  ][, f18 := .N / nrow(dt), by = "SmartScreen,Census_IsPenCapable"
  ][, f19 := .N / nrow(dt), by = "AVProductStatesIdentifier,Census_ProcessorClass"
  ][, f20 := .N / nrow(dt), by = "AVProductStatesIdentifier,Census_IsPenCapable"
  ][, f21 := .N / nrow(dt), by = "AVProductStatesIdentifier,UacLuaenable"
  ][, f22 := .N / nrow(dt), by = "AVProductStatesIdentifier,Census_PrimaryDiskTypeName"
  ][, f23 := .N / nrow(dt), by = "AVProductStatesIdentifier,Census_IsPortableOperatingSystem"
  ][, f24 := .N / nrow(dt), by = "AVProductStatesIdentifier,AutoSampleOptIn"
  ][, f25 := .N / nrow(dt), by = "AVProductStatesIdentifier,AVProductsEnabled"
  ][, f26 := .N / nrow(dt), by = "AVProductStatesIdentifier,AVProductsInstalled"
  ][, f27 := .N / nrow(dt), by = "AVProductStatesIdentifier,IsProtected"
  ][, f28 := .N / nrow(dt), by = "ProductName,AVProductStatesIdentifier"
  ][, f29 := .N / nrow(dt), by = "IsBeta,AVProductStatesIdentifier"
  ][, f30 := .N / nrow(dt), by = "IsSxsPassiveMode,AVProductStatesIdentifier"
  ][, f31 := .N / nrow(dt), by = "AVProductStatesIdentifier,Census_DeviceFamily"
  ][, f32 := .N / nrow(dt), by = "RtpStateBitfield,AVProductStatesIdentifier"
  ][, f33 := .N / nrow(dt), by = "AVProductStatesIdentifier,Census_OSInstallTypeName"
  ][, f34 := .N / nrow(dt), by = "AVProductStatesIdentifier,HasTpm"
  ][, f35 := .N / nrow(dt), by = "OsSuite,SmartScreen"
  ][, f36 := .N / nrow(dt), by = "SmartScreen,Census_OSEdition"
  ][, f37 := .N / nrow(dt), by = "AVProductsInstalled,Census_ThresholdOptIn"
  ][, f38 := .N / nrow(dt), by = "AVProductsInstalled,Census_IsWIMBootEnabled"
  ][, f39 := .N / nrow(dt), by = "AVProductsInstalled,IsProtected"
  ][, f40 := .N / nrow(dt), by = "AVProductStatesIdentifier,Census_IsFlightsDisabled"
  ][, f41 := .N / nrow(dt), by = "SmartScreen,Census_OSSkuName"
  ][, f42 := .N / nrow(dt), by = "AVProductStatesIdentifier,Census_IsTouchEnabled"
  ][, f43 := .N / nrow(dt), by = "AVProductsInstalled,Census_IsVirtualDevice"
  ][, f45 := .N / nrow(dt), by = "EngineVersion,AVProductStatesIdentifier"
  ][, f46 := .N / nrow(dt), by = "DefaultBrowsersIdentifier,AVProductStatesIdentifier"
  ][, f47 := .N / nrow(dt), by = "SmartScreen,Census_HasOpticalDiskDrive"
  ][, f48 := .N / nrow(dt), by = "IsSxsPassiveMode,SmartScreen"
  ][, f49 := .N / nrow(dt), by = "AVProductStatesIdentifier,Census_IsVirtualDevice"
  ][, f51 := .N / nrow(dt), by = "EngineVersion,AVProductsInstalled"
  ][, f52 := .N / nrow(dt), by = "SmartScreen,Wdft_IsGamer"
  ][, f53 := .N / nrow(dt), by = "AVProductStatesIdentifier,Census_IsFlightingInternal"
  ][, f54 := .N / nrow(dt), by = "Platform,SmartScreen"
  ][, f55 := .N / nrow(dt), by = "AVProductsInstalled,Census_IsAlwaysOnAlwaysConnectedCapable"
  ][, f56 := .N / nrow(dt), by = "OsVer,SmartScreen"
  ][, f57 := .N / nrow(dt), by = "AVProductStatesIdentifier,Census_IsWIMBootEnabled"
  ][, f58 := .N / nrow(dt), by = "AVProductStatesIdentifier,Census_ThresholdOptIn"
  ][, f59 := .N / nrow(dt), by = "AVProductStatesIdentifier,PuaMode"
  ][, f60 := .N / nrow(dt), by = "AVProductsInstalled,Census_OSArchitecture"
  ][, f61 := .N / nrow(dt), by = "AVProductsInstalled,Processor"
  ][, f62 := .N / nrow(dt), by = "SmartScreen,Census_IsVirtualDevice"
  ][, f63 := .N / nrow(dt), by = "SmartScreen,Firewall"
  ][, f64 := .N / nrow(dt), by = "AVProductStatesIdentifier,Census_IsAlwaysOnAlwaysConnectedCapable"
  ][, f65 := .N / nrow(dt), by = "AVProductStatesIdentifier,Census_OSArchitecture"
  ][, f66 := .N / nrow(dt), by = "AVProductStatesIdentifier,Processor"
  ][, f67 := .N / nrow(dt), by = "HasTpm,SmartScreen"
  ][, f68 := .N / nrow(dt), by = "ProductName,SmartScreen"
  ][, f69 := .N / nrow(dt), by = "SmartScreen,Census_IsSecureBootEnabled"
  ][, f70 := .N / nrow(dt), by = "SmartScreen,UacLuaenable"
  ][, f71 := .N / nrow(dt), by = "SmartScreen,Census_ProcessorClass"
  ][, f72 := .N / nrow(dt), by = "SMode,SmartScreen"
  ][, f73 := .N / nrow(dt), by = "SmartScreen,Census_DeviceFamily"
  ][, f74 := .N / nrow(dt), by = "SmartScreen,Census_IsPortableOperatingSystem"
  ][, f75 := .N / nrow(dt), by = "SmartScreen,Census_IsFlightsDisabled"
  ][, f76 := .N / nrow(dt), by = "AutoSampleOptIn,SmartScreen"
  ][, f77 := .N / nrow(dt), by = "IsBeta,SmartScreen"
  ][, f78 := .N / nrow(dt), by = "SmartScreen,Census_IsFlightingInternal"
  ][, f79 := .N / nrow(dt), by = "SmartScreen,Census_ThresholdOptIn"
  ][, f80 := .N / nrow(dt), by = "SmartScreen,Census_IsWIMBootEnabled"
  ][, f81 := .N, by = "AvSigVersion,Wdft_IsGamer,Census_OSInstallLanguageIdentifier"
  ][, f82 := .N, by = "Census_ProcessorCoreCount,Wdft_RegionIdentifier,Census_OSBuildNumber"
  ][, f83 := .N, by = "Census_ProcessorCoreCount,Census_OEMNameIdentifier,CityIdentifier"
  ][, f84 := .N, by = "GeoNameIdentifier,Census_OEMNameIdentifier,Census_OSBuildRevision"]
#---------------------------
cat("Converting character columns...\n")

cats <- names(which(sapply(dt, is.character)))
dt[, (cats) := lapply(.SD, function(x) as.integer(as.factor(x))), .SDcols = cats]  

dt <- data.matrix(dt)

rm(cats); invisible(gc())

#---------------------------
cat("Preparing data for boosting...\n")

tr <- lgb.Dataset(data = dt[1:N, ], label = y)
te <- dt[-(1:N), ]

rm(dt, y, N); invisible(gc())

#---------------------------
cat("Training model and predicting...\n")

subm <- fread("../input/sample_submission.csv")
subm[, HasDetections := 0]

n_bags <- 5
for (i in seq(0.7, 0.9, length.out = n_bags)) {
  cat("bag ", i, "\n")
  p <- list(boosting_type = "gbdt", 
            objective = "binary",
            num_threads=26,
            metric = "auc", 
            learning_rate = 0.05, 
            max_depth = 5,
            num_leaves = 20,
            sub_feature = i, 
            sub_row = i, 
            bagging_freq = 1,
            lambda_l1 = 0.1, 
            lambda_l2 = 0.1)
  
  m_gbm <- lgb.train(p, tr, 6000, verbose = -1)
  subm[, HasDetections := HasDetections + predict(m_gbm, te) / n_bags]
  
  rm(m_gbm); invisible(gc())
}

#---------------------------
cat("Making submission file...\n")

fwrite(subm, "../output/rstarter-v2-corrfeat2-02.csv")