import numpy as np
import pandas as pd
import os
import kaggle

from scipy.stats import rankdata

LABELS = ["HasDetections"]


df1_fname = 'rstarter-v2-corrfeat2.csv.gz'
df2_fname = 'nffm_submission.csv.gz'
df3_fname = 'sparse_matrices_kernel_sub.csv.gz'
df4_fname = 'submit_e67_cv074536.csv.gz'

blend_name = 'blend_v11_rankblend.csv.gz'
output_dir =  '../output/'

df1 = pd.read_csv(os.path.join(output_dir, df1_fname), compression='gzip')
df2 = pd.read_csv(os.path.join(output_dir, df2_fname), compression='gzip')
df3 = pd.read_csv(os.path.join(output_dir, df3_fname), compression='gzip')
df4 = pd.read_csv(os.path.join(output_dir, df4_fname), compression='gzip')

predict_list = []

predict_list.append(df1[LABELS].values)
predict_list.append(df2[LABELS].values)
predict_list.append(df3[LABELS].values)
predict_list.append(df4[LABELS].values)

print("Rank averaging on ", len(predict_list), " files")
predictions = np.zeros_like(predict_list[0])
for predict in predict_list:
    for i in range(1):
        predictions[:, i] = np.add(predictions[:, i], rankdata(predict[:, i])/predictions.shape[0])  
predictions /= len(predict_list)

submission = pd.read_csv('../input/sample_submission.csv')
submission[LABELS] = predictions
submission.to_csv(os.path.join(output_dir, blend_name), compression='gzip', index=False)

message = 'Superblend by Scipy'
competition = 'microsoft-malware-prediction'
kaggle.api.competition_submit(os.path.abspath(os.path.join(output_dir, blend_name)), message, competition)