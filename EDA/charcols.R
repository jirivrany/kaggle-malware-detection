library(lightgbm)
library(data.table)

set.seed(3)

#---------------------------
cat("Loading data...\n")

dt <- fread("../input/train.csv", drop = "MachineIdentifier")
dt <- dt[sample(.N, .N %/% 2), ]

y <- dt[, HasDetections]
dt[, HasDetections := NULL]
N <- dt[, .N]

dt <- rbind(dt, fread("../input/test.csv", drop = "MachineIdentifier"))

#---------------------------
cat("Adding features...\n")
cat("before", dim(dt), "\n")
dt[, f1 := .N / nrow(dt), by = "AvSigVersion,Wdft_IsGamer"
  ][, f2 := .N / nrow(dt), by = "Census_ProcessorCoreCount,Wdft_RegionIdentifier"
  ][, f3 := .N / nrow(dt), by = "Census_ProcessorCoreCount,Census_OEMNameIdentifier"
  ][, f4 := .N / nrow(dt), by = "GeoNameIdentifier,Census_OEMNameIdentifier"]

cat("after", dim(dt), "\n")
cat("nrow", nrow(dt), "\n")
cat("head", head(dt), "\n")
#---------------------------
cat("Converting character columns...\n")

cats <- names(which(sapply(dt, is.character)))

cat(cats)