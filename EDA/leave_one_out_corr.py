import pandas as pd
import numpy as np

train = pd.read_pickle('../input/train.pkl')

cols = list(train.columns)
target = 'HasDetections'
cols.remove(target)

for col in cols:
    new_feature = 'fe_{}_target_mean_enc'.format(col)
    groups_sum = train.groupby(col)[target].transform('sum')
    nr_groups = train.groupby(col)[target].transform('count')
    train[new_feature] = (groups_sum - train[target]) / (nr_groups - 1)
    train[new_feature].fillna(train[new_feature].mean(), inplace=True) 
    
    corr = train[target].corr(train[new_feature])
    if corr > 0.1:
        print(corr, col)
